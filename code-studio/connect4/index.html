<!DOCTYPE html>
<html>
	<head>
		<style>
			#welcome_screen,body,html {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0;
			}

			#welcome_screen {
				position: absolute;
				background-color: red;
				display: none;
			}

			.board_space {
				background-color: yellow;
				width: 50px;
				height: 50px;
				padding: 0;
			}

			.token {
				width: (100% - 10px);
				height: calc(100% - 10px);
				border: 5px solid transparent;
				pointer-events: none;
				animation: token_drop 1s ease-in;
				border-radius: 50%;
			}

			@keyframes token_drop {
				70%, 90%, 100% { transform: translateY(0); }
				0% { transform: translateY(-100vh); }
				80% { transform: translateY(-20px); }
				95% { transform: translateY(-5px); }
			}

			.p1_token {
				background-color: blue;
			}

			.p2_token {
				background-color: red;
			}

			.winning_token {
				animation: show_winning_tokens 1s ease-in-out 0s infinite;
			}

			@keyframes show_winning_tokens {
				0%,100% { border-color: transparent; }
				50% { border-color: green; }
			}
		</style>
	</head>
	<body>
		<div id="game_board_wrapper">
			<table id="game_board"></table>
		</div>
		<div id="welcome_screen">
			<h1>Welcome to Connect 4!</h1>
			<form id="player_info">
				<input type=text id="player1_name"></input>
				<input type=text id="player2_name"></input>
				<input type=submit id="start_button"></input>
			</form>
		</div>
	</body>
	<script>
		const board = document.getElementById("game_board");
		var playerTurn;

		document.getElementById("player_info").addEventListener("submit", function(e) {
			e.preventDefault();
			start();
		});

		start();

		function start() {
			document.getElementById("welcome_screen").style.display = "none";
			playerTurn = Math.round(Math.random()) + 1;
			createGameBoard();
		}

		function createGameBoard() {
			for (let r = 0; r < 6; r++) {
				let row = document.createElement("tr");
				for (let c = 0; c < 7; c++) {
					let col = document.createElement("td");
					col.classList.add("board_space");
					col.addEventListener("click", cellClicked);
					row.appendChild(col);
				}
				board.appendChild(row);
			}
		}

		function cellClicked(e) {
			let cell = getLowestCell(e.target.cellIndex);

			if (!cell)
				return;

			addToken(cell);

			checkForWin(cell.cellIndex, cell.parentElement.rowIndex);
			
			playerTurn = (playerTurn == 1) ? 2 : 1;
		}

		function getLowestCell(pos) {
			for (let r = 5; r >= 0; r--) {
				if (!board.rows[r].cells[pos].firstChild)
					return board.rows[r].cells[pos];
			}

			return null;
		}

		function addToken(cell) {
			let token = document.createElement("div");
			token.classList.add("token");

			if (playerTurn == 1)
				token.classList.add("p1_token");
			else
				token.classList.add("p2_token");

			cell.appendChild(token);
		}

		function checkForWin(x, y) {
			for (let angle = 0; angle < Math.PI; angle += Math.PI / 4) {
				let dir1Amount = checkDirection(x, y, Math.round(Math.cos(angle)), Math.round(Math.sin(angle)));
				let dir2Amount = checkDirection(x, y, Math.round(Math.cos(angle + Math.PI)), Math.round(Math.sin(angle + Math.PI)));

				if (dir1Amount + dir2Amount >= 3) {
					board.style.pointerEvents = "none";
					
					setTimeout(function() {
						let xDir = Math.round(Math.cos(angle));
						let yDir = Math.round(Math.sin(angle));

						for (let i = 0; i <= dir1Amount + dir2Amount; i++) {
							board.rows[y - dir2Amount * yDir + yDir * i].cells[x - dir2Amount * xDir + xDir * i].firstChild.classList.add("winning_token");
						}
					}, 1000);

					return true;
				}
			}

			return false;
		}

		function checkDirection(x, y, xDir, yDir) {
			let amount = 0;

			x += xDir;
			y += yDir;

			while (x >= 0 && x < 7 && y >= 0 && y < 6) {
				if (checkCellOwnership(x, y) != playerTurn)
					return amount;

				amount++;
				
				x += xDir;
				y += yDir;
			}
			
			return amount;
		}

		function checkCellOwnership(x, y) {
			if (!board.rows[y].cells[x].firstChild)
				return null;
			else if (board.rows[y].cells[x].firstChild.classList.contains("p1_token"))
				return 1;
			else if (board.rows[y].cells[x].firstChild.classList.contains("p2_token"))
				return 2;
			else
				return null;
		}
	</script>
</html>
